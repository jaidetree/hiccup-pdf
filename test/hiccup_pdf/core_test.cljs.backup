(ns hiccup-pdf.core-test
  (:require [cljs.test :refer [deftest is testing]]
            [clojure.string :as str]
            [hiccup-pdf.core :refer [hiccup->pdf-ops]]))

(deftest smoke-test
  (testing "hiccup->pdf-ops function exists and can be called"
    (is (= "10 20 100 50 re\nf" (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50}]))
        "Function should return PDF operators for rectangle")
    
    (is (= "10 20 100 50 re\nf" (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50}] {}))
        "Function should accept options parameter")
    
    (is (string? (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25}]))
        "Function should return PDF operators for circle")))

(deftest basic-function-calls
  (testing "Function accepts various hiccup element types"
    (is (string? (hiccup->pdf-ops [:rect {:x 0 :y 0 :width 100 :height 50}]))
        "Rectangle elements should return a string")
    
    (is (string? (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25}]))
        "Circle elements should return a string")
    
    (is (string? (hiccup->pdf-ops [:line {:x1 0 :y1 0 :x2 100 :y2 100}]))
        "Line elements should return a string")
    
    (is (string? (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Hello"]))
        "Text elements should return a string")
    
    (is (string? (hiccup->pdf-ops [:path {:d "M10,10 L20,20"}]))
        "Path elements should return a string")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:g {} [:rect {:x 0 :y 0 :width 50 :height 50}]]))
        "Group elements should throw error (not implemented)")))

(deftest function-signature-tests
  (testing "Function signature variations"
    (is (thrown? js/Error (hiccup->pdf-ops [:rect {:x 10 :y 20}]))
        "Single argument call with missing attributes should throw error")
    
    (is (= "10 20 100 50 re\nf" (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50}] nil))
        "Two argument call with nil options should work")
    
    (is (= "10 20 100 50 re\nf" (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50}] {:some-option true}))
        "Two argument call with options map should work")))

(deftest rect-element-test
  (testing "Rectangle element transformation"
    (is (= "10 20 100 50 re\nf"
           (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50}]))
        "Should generate correct PDF operators for rectangle")
    
    (is (= "0 0 1 1 re\nf"
           (hiccup->pdf-ops [:rect {:x 0 :y 0 :width 1 :height 1}]))
        "Should generate correct PDF operators for minimal rectangle"))
  
  (testing "Rectangle element validation errors"
    (is (thrown? js/Error (hiccup->pdf-ops [:rect {:x 10 :y 20}]))
        "Should throw error for missing width and height")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:rect {:x "10" :y 20 :width 100 :height 50}]))
        "Should throw error for non-numeric attributes")))

(deftest rect-styling-test
  (testing "Rectangle with fill styling"
    (is (= "1 0 0 rg\n10 20 100 50 re\nf"
           (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50 :fill "red"}]))
        "Should generate PDF operators for filled rectangle")
    
    (is (= "1 0 0 rg\n10 20 100 50 re\nf"
           (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50 :fill "#ff0000"}]))
        "Should generate PDF operators for hex color fill"))
  
  (testing "Rectangle with stroke styling"
    (is (= "0 0 1 RG\n10 20 100 50 re\nS"
           (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50 :stroke "blue"}]))
        "Should generate PDF operators for stroked rectangle")
    
    (is (= "2 w\n0 0 1 RG\n10 20 100 50 re\nS"
           (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50 :stroke "blue" :stroke-width 2}]))
        "Should generate PDF operators for stroked rectangle with width"))
  
  (testing "Rectangle with both fill and stroke"
    (is (= "1 0 0 rg\n0 0 1 RG\n10 20 100 50 re\nB"
           (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50 :fill "red" :stroke "blue"}]))
        "Should generate PDF operators for filled and stroked rectangle")
    
    (is (= "1.5 w\n1 0 0 rg\n0 0 1 RG\n10 20 100 50 re\nB"
           (hiccup->pdf-ops [:rect {:x 10 :y 20 :width 100 :height 50 :fill "red" :stroke "blue" :stroke-width 1.5}]))
        "Should generate PDF operators for filled and stroked rectangle with width")))

(deftest line-element-test
  (testing "Line element transformation"
    (is (= "0 0 0 RG\n10 20 m\n100 50 l\nS"
           (hiccup->pdf-ops [:line {:x1 10 :y1 20 :x2 100 :y2 50}]))
        "Should generate correct PDF operators for basic line")
    
    (is (= "0 0 0 RG\n0 0 m\n1 1 l\nS"
           (hiccup->pdf-ops [:line {:x1 0 :y1 0 :x2 1 :y2 1}]))
        "Should generate correct PDF operators for minimal line"))
  
  (testing "Line element validation errors"
    (is (thrown? js/Error (hiccup->pdf-ops [:line {:x1 10 :y1 20}]))
        "Should throw error for missing x2 and y2")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:line {:x1 "10" :y1 20 :x2 100 :y2 50}]))
        "Should throw error for non-numeric attributes")))

(deftest line-styling-test
  (testing "Line with stroke styling"
    (is (= "1 0 0 RG\n10 20 m\n100 50 l\nS"
           (hiccup->pdf-ops [:line {:x1 10 :y1 20 :x2 100 :y2 50 :stroke "red"}]))
        "Should generate PDF operators for colored line")
    
    (is (= "2 w\n0 0 1 RG\n10 20 m\n100 50 l\nS"
           (hiccup->pdf-ops [:line {:x1 10 :y1 20 :x2 100 :y2 50 :stroke "blue" :stroke-width 2}]))
        "Should generate PDF operators for line with stroke width")
    
    (is (= "1 0 0 RG\n10 20 m\n100 50 l\nS"
           (hiccup->pdf-ops [:line {:x1 10 :y1 20 :x2 100 :y2 50 :stroke "#ff0000"}]))
        "Should generate PDF operators for hex color line")))

(deftest circle-element-test
  (testing "Circle element transformation"
    (let [result (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25}])]
      (is (string? result)
          "Should generate string output for basic circle")
      (is (re-find #"50 75 m\n" result)
          "Should start path at top of circle")
      (is (re-find #"c\n.*c\n.*c\n.*c\n" result)
          "Should contain 4 cubic BÃ©zier curves")
      (is (re-find #"f$" result)
          "Should end with fill operator"))
    
    (let [result (hiccup->pdf-ops [:circle {:cx 0 :cy 0 :r 1}])]
      (is (string? result)
          "Should generate string output for minimal circle")
      (is (re-find #"0 1 m\n" result)
          "Should start path at correct position")))
  
  (testing "Circle element validation errors"
    (is (thrown? js/Error (hiccup->pdf-ops [:circle {:cx 50 :cy 50}]))
        "Should throw error for missing radius")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:circle {:cx "50" :cy 50 :r 25}]))
        "Should throw error for non-numeric attributes")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r -5}]))
        "Should throw error for negative radius")))

(deftest circle-styling-test
  (testing "Circle with fill styling"
    (let [result (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25 :fill "red"}])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should contain fill color operator")
      (is (re-find #"f$" result)
          "Should end with fill operator"))
    
    (let [result (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25 :fill "#ff0000"}])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should handle hex color fill")))
  
  (testing "Circle with stroke styling"
    (let [result (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25 :stroke "blue"}])]
      (is (re-find #"0 0 1 RG\n" result)
          "Should contain stroke color operator")
      (is (re-find #"S$" result)
          "Should end with stroke operator"))
    
    (let [result (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25 :stroke "blue" :stroke-width 2}])]
      (is (re-find #"2 w\n" result)
          "Should contain stroke width operator")))
  
  (testing "Circle with both fill and stroke"
    (let [result (hiccup->pdf-ops [:circle {:cx 50 :cy 50 :r 25 :fill "red" :stroke "blue"}])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should contain fill color")
      (is (re-find #"0 0 1 RG\n" result)
          "Should contain stroke color")
      (is (re-find #"B$" result)
          "Should end with both fill and stroke operator")))
  
  (testing "Edge case: zero radius circle"
    (let [result (hiccup->pdf-ops [:circle {:cx 10 :cy 20 :r 0}])]
      (is (string? result)
          "Should handle zero radius circle")
      (is (re-find #"10 20 m\n" result)
          "Should start at center point"))))

(deftest path-element-test
  (testing "Path element transformation"
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 L20,20"}])]
      (is (string? result)
          "Should generate string output for basic path")
      (is (re-find #"10 10 m\n" result)
          "Should contain move command")
      (is (re-find #"20 20 l\n" result)
          "Should contain line command")
      (is (re-find #"f$" result)
          "Should end with fill operator"))
    
    (let [result (hiccup->pdf-ops [:path {:d "M0,0 L100,100 Z"}])]
      (is (string? result)
          "Should generate string output for closed path")
      (is (re-find #"0 0 m\n" result)
          "Should start with move command")
      (is (re-find #"100 100 l\n" result)
          "Should contain line command")
      (is (re-find #"h\n" result)
          "Should contain close path command"))
    
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 C20,20 30,30 40,40"}])]
      (is (string? result)
          "Should generate string output for curve path")
      (is (re-find #"10 10 m\n" result)
          "Should start with move command")
      (is (re-find #"20 20 30 30 40 40 c\n" result)
          "Should contain cubic curve command")))
  
  (testing "Path element validation errors"
    (is (thrown? js/Error (hiccup->pdf-ops [:path {}]))
        "Should throw error for missing d attribute")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:path {:d ""}]))
        "Should throw error for empty d attribute")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:path {:d 123}]))
        "Should throw error for non-string d attribute")))

(deftest path-styling-test
  (testing "Path with fill styling"
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 L20,20" :fill "red"}])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should contain fill color operator")
      (is (re-find #"f$" result)
          "Should end with fill operator"))
    
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 L20,20" :fill "#ff0000"}])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should handle hex color fill")))
  
  (testing "Path with stroke styling"
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 L20,20" :stroke "blue"}])]
      (is (re-find #"0 0 1 RG\n" result)
          "Should contain stroke color operator")
      (is (re-find #"S$" result)
          "Should end with stroke operator"))
    
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 L20,20" :stroke "blue" :stroke-width 2}])]
      (is (re-find #"2 w\n" result)
          "Should contain stroke width operator")))
  
  (testing "Path with both fill and stroke"
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 L20,20" :fill "red" :stroke "blue"}])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should contain fill color")
      (is (re-find #"0 0 1 RG\n" result)
          "Should contain stroke color")
      (is (re-find #"B$" result)
          "Should end with both fill and stroke operator")))
  
  (testing "Complex path commands"
    (let [result (hiccup->pdf-ops [:path {:d "M10,10 L20,20 L30,10 Z"}])]
      (is (re-find #"10 10 m\n" result)
          "Should start with move")
      (is (re-find #"20 20 l\n" result)
          "Should contain first line")
      (is (re-find #"30 10 l\n" result)
          "Should contain second line")
      (is (re-find #"h\n" result)
          "Should close path"))))

(deftest text-element-test
  (testing "Text element transformation"
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Hello"])]
      (is (string? result)
          "Should generate string output for text")
      (is (re-find #"BT\n" result)
          "Should start with begin text operator")
      (is (re-find #"0 0 0 rg\n" result)
          "Should contain default black color")
      (is (re-find #"/Arial 12 Tf\n" result)
          "Should contain font specification")
      (is (re-find #"10 20 Td\n" result)
          "Should contain text positioning")
      (is (re-find #"\(Hello\) Tj\n" result)
          "Should contain text content")
      (is (re-find #"ET$" result)
          "Should end with end text operator"))
    
    (let [result (hiccup->pdf-ops [:text {:x 0 :y 0 :font "Times" :size 8} "Test"])]
      (is (string? result)
          "Should generate string output for minimal text")
      (is (re-find #"/Times 8 Tf\n" result)
          "Should contain correct font and size")
      (is (re-find #"0 0 Td\n" result)
          "Should contain correct position")
      (is (re-find #"\(Test\) Tj\n" result)
          "Should contain correct text")))
  
  (testing "Text element validation errors"
    (is (thrown? js/Error (hiccup->pdf-ops [:text {:x 10 :y 20} "Hello"]))
        "Should throw error for missing font and size")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:text {:x "10" :y 20 :font "Arial" :size 12} "Hello"]))
        "Should throw error for non-numeric coordinates")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:text {:x 10 :y 20 :font "" :size 12} "Hello"]))
        "Should throw error for empty font name")
    
    (is (thrown? js/Error (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 0} "Hello"]))
        "Should throw error for zero font size")))

(deftest text-styling-test
  (testing "Text with fill styling"
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12 :fill "red"} "Hello"])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should contain red color operator")
      (is (re-find #"BT\n" result)
          "Should contain text block operators"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12 :fill "#ff0000"} "Hello"])]
      (is (re-find #"1 0 0 rg\n" result)
          "Should handle hex color fill")))
  
  (testing "Text content variations"
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12}])]
      (is (re-find #"\(\) Tj\n" result)
          "Should handle missing text content"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} ""])]
      (is (re-find #"\(\) Tj\n" result)
          "Should handle empty text content"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Multi word text"])]
      (is (re-find #"\(Multi word text\) Tj\n" result)
          "Should handle multi-word text"))))

(deftest text-emoji-and-special-chars-test
  (testing "Text with emoji support"
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Hello ðŸ˜€ World"])]
      (is (string? result)
          "Should handle emoji characters")
      (is (re-find #"\(Hello ðŸ˜€ World\) Tj\n" result)
          "Should contain emoji in text content"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "ðŸŽ‰ðŸš€âœ¨"])]
      (is (re-find #"\(ðŸŽ‰ðŸš€âœ¨\) Tj\n" result)
          "Should handle multiple emojis"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Text with emoji ðŸŽ¨ and more text"])]
      (is (re-find #"\(Text with emoji ðŸŽ¨ and more text\) Tj\n" result)
          "Should handle mixed text and emoji")))
  
  (testing "Text with special PDF characters"
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Text with (parentheses)"])]
      (is (re-find #"\(Text with \\\(parentheses\\\)\) Tj\n" result)
          "Should escape parentheses in text"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Text with \\ backslash"])]
      (is (str/includes? result "(Text with \\\\\\\\ backslash) Tj")
          "Should escape backslashes in text"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Complex (text) with \\ special chars"])]
      (is (str/includes? result "(Complex \\\\(text\\\\) with \\\\\\\\ special chars) Tj")
          "Should escape multiple special characters")))
  
  (testing "Text with various fonts and emoji"
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Times-Roman" :size 14} "Times font with ðŸ“š book emoji"])]
      (is (re-find #"/Times-Roman 14 Tf\n" result)
          "Should work with Times-Roman font")
      (is (re-find #"\(Times font with ðŸ“š book emoji\) Tj\n" result)
          "Should render emoji with Times font"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Helvetica" :size 16} "Helvetica with ðŸŒŸ star"])]
      (is (re-find #"/Helvetica 16 Tf\n" result)
          "Should work with Helvetica font")
      (is (re-find #"\(Helvetica with ðŸŒŸ star\) Tj\n" result)
          "Should render emoji with Helvetica font")))
  
  (testing "Edge cases with emoji and special characters"
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "ðŸ”¥(hot)ðŸ”¥"])]
      (is (re-find #"\(ðŸ”¥\\\(hot\\\)ðŸ”¥\) Tj\n" result)
          "Should handle emoji with special characters"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} ""])]
      (is (re-find #"\(\) Tj\n" result)
          "Should handle empty string"))
    
    (let [result (hiccup->pdf-ops [:text {:x 10 :y 20 :font "Arial" :size 12} "Line 1\nLine 2"])]
      (is (re-find #"\(Line 1\nLine 2\) Tj\n" result)
          "Should handle newline characters"))))
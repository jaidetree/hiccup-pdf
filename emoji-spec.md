# Emoji Image Embedding Specification

## Overview

This specification defines the implementation for embedding emoji as PNG images in PDF documents generated by the hiccup-pdf library. The system will replace Unicode emoji characters with high-quality PNG images from the local Noto emoji library, providing consistent cross-platform emoji rendering.

## Goals

- **Consistent Rendering**: Emoji appear identically across all PDF viewers and platforms
- **High Quality**: Use 72px Noto emoji PNGs for crisp rendering at typical document sizes
- **Performance**: Efficient image caching and reuse within documents
- **Backwards Compatibility**: Fallback to existing hex string encoding when images unavailable
- **Developer Experience**: Simple API with sensible defaults

## Architecture Overview

```
Text Processing Pipeline:
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Parse Text      │───▶│ Detect Emoji    │───▶│ Split Content   │
│ Content         │    │ Characters      │    │ Text/Image      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Generate PDF    │◀───│ Load PNG Files  │◀───│ Map Unicode to  │
│ Operators       │    │ from Disk       │    │ File Paths      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Data Structures

### Emoji Mapping

```clojure
;; Unicode codepoint to filename mapping
(def emoji-file-map
  {0x1F4A1 "emoji_u1f4a1.png"        ; 💡 lightbulb
   0x1F3AF "emoji_u1f3af.png"        ; 🎯 target  
   0x26A0  "emoji_u26a0.png"         ; ⚠️ warning
   0x2705  "emoji_u2705.png"         ; ✅ checkmark
   0x2022  "emoji_u2022.png"         ; • bullet point
   ;; Additional mappings as needed
   })

;; Image cache structure
(def image-cache
  {:emoji-ref-1 {:buffer #<Buffer>
                 :width 72
                 :height 72
                 :object-ref "Em1"}
   ;; More cached images...
   })
```

### Content Segment Structure

```clojure
;; Mixed content representation
{:segments [{:type :text :content "Hello "}
            {:type :image :emoji "💡" :ref "Em1" :width 14 :height 14}
            {:type :text :content " world!"}]
 :images {"Em1" {:buffer #<Buffer> :width 72 :height 72}}}
```

## Core Components

### 1. Unicode Processing (`hiccup-pdf.emoji`)

**Function: `extract-emoji-codepoints`**
```clojure
(defn extract-emoji-codepoints
  "Extracts Unicode codepoints from emoji characters, handling surrogate pairs"
  [emoji-char]
  ;; Returns: vector of codepoints [0x1F4A1] or [0xD83D 0xDCA1]
  )
```

**Function: `unicode-to-filename`**
```clojure
(defn unicode-to-filename
  "Converts Unicode codepoint(s) to Noto emoji filename"
  [codepoints]
  ;; Returns: "emoji_u1f4a1.png"
  )
```

**Function: `detect-emoji-in-text`**
```clojure
(defn detect-emoji-in-text
  "Scans text for emoji characters using Unicode ranges"
  [text-content]
  ;; Returns: [{:char "💡" :start-index 5 :end-index 7}]
  )
```

### 2. Image Management (`hiccup-pdf.images`)

**Function: `load-emoji-image`**
```clojure
(defn load-emoji-image
  "Loads PNG image from local emoji directory with caching"
  [emoji-char options]
  ;; Returns: Promise<{:buffer Buffer :width 72 :height 72}>
  )
```

**Function: `generate-pdf-image-object`**
```clojure
(defn generate-pdf-image-object
  "Creates PDF XObject for PNG image with proper compression"
  [image-data object-num]
  ;; Returns: PDF object string
  )
```

### 3. Text Processing (`hiccup-pdf.text-processing`)

**Function: `split-text-with-emoji`**
```clojure
(defn split-text-with-emoji
  "Splits text into segments of text and emoji characters"
  [text-content options]
  ;; Returns: {:segments [...] :emoji-refs {...}}
  )
```

**Function: `render-mixed-content`**
```clojure
(defn render-mixed-content
  "Generates PDF operators for mixed text and image content"
  [x y segments font-size fill-color]
  ;; Returns: PDF operator string
  )
```

## Implementation Requirements

### 1. Unicode Support

- **Surrogate Pair Handling**: Properly decode 4-byte Unicode emoji (U+1F4A1)
- **Composite Emoji**: Support ZWJ sequences and skin tone modifiers
- **Fallback Strategy**: Use hex string encoding when image not available

```clojure
;; Example: Lightbulb emoji 💡
;; Unicode: U+1F4A1
;; UTF-16 surrogate pair: 0xD83D 0xDCA1  
;; Noto filename: "emoji_u1f4a1.png"
```

### 2. Image Loading and Caching

- **Local File Access**: Read PNG files from `emojis/noto-72/` directory
- **Memory Caching**: Cache loaded images per document generation session
- **Async Handling**: Non-blocking image loading with Promise-based API
- **Error Handling**: Graceful fallback when image files missing

### 3. PDF Image Embedding

- **XObject Generation**: Create proper PDF image objects with DCTDecode filter
- **Resource Dictionary**: Include image references in page resources
- **Coordinate Alignment**: Align image baseline with text baseline
- **Size Scaling**: Scale 72px images to match font size

```clojure
;; PDF XObject structure
"5 0 obj
<<
/Type /XObject
/Subtype /Image  
/Width 72
/Height 72
/ColorSpace /DeviceRGB
/BitsPerComponent 8
/Filter /DCTDecode
/Length 3421
>>
stream
<PNG binary data>
endstream
endobj"
```

### 4. Layout and Positioning

- **Baseline Alignment**: Position emoji images on text baseline
- **Horizontal Spacing**: Add appropriate spacing between text and images
- **Font Size Scaling**: Scale image size to match text font size
- **Line Height**: Consider emoji height for line spacing calculations

```clojure
;; Positioning calculation
(defn calculate-emoji-position [font-size baseline-y]
  (let [emoji-size font-size
        y-offset (* font-size 0.2)]  ; Baseline adjustment
    {:width emoji-size 
     :height emoji-size
     :y (- baseline-y y-offset)}))
```

## API Design

### Configuration Options

```clojure
;; Global emoji configuration
(def emoji-options
  {:enable-emoji-images true           ; Enable/disable feature
   :emoji-directory "emojis/noto-72/"  ; Path to emoji PNG files
   :fallback-strategy :hex-string      ; :hex-string, :text, :skip
   :cache-size 100                     ; Max cached images
   :baseline-adjust 0.2                ; Baseline offset ratio
   :min-font-size 8                    ; Minimum size for image emoji
   :max-font-size 72})                 ; Maximum size for image emoji
```

### Enhanced Text Function

```clojure
(defn text->pdf-ops
  "Enhanced text function with emoji image support"
  [attributes content options]
  (let [emoji-enabled? (:enable-emoji-images options false)]
    (if emoji-enabled?
      (render-text-with-emoji-images attributes content options)
      (render-text-current-method attributes content))))
```

### Document-Level Integration

```clojure
(defn hiccup->pdf-document
  "Enhanced document function with emoji support"
  [hiccup-doc options]
  (let [emoji-config (:emoji options {})]
    ;; Pre-scan document for emoji
    ;; Load all required images
    ;; Generate document with embedded images
    ))
```

## Error Handling Strategy

### Image Loading Errors

```clojure
(defn handle-emoji-image-error
  "Handles missing or corrupted emoji image files"
  [emoji-char error fallback-strategy]
  (case fallback-strategy
    :hex-string (encode-emoji-as-hex emoji-char)
    :text       (str "[" emoji-char "]")
    :skip       ""
    :error      (throw error)))
```

### Validation Errors

- **Invalid Unicode**: Log warning and use fallback encoding
- **File System Access**: Graceful degradation when emoji directory inaccessible
- **Memory Limits**: Clear cache when approaching memory limits
- **PDF Generation**: Validate image objects before embedding

## Performance Considerations

### Optimization Strategies

1. **Lazy Loading**: Load images only when needed
2. **Batch Processing**: Load all document emoji in single pass
3. **Memory Management**: Implement LRU cache with size limits
4. **File System**: Use async file operations to prevent blocking

### Performance Targets

- **Image Loading**: < 10ms per emoji (cached)
- **Memory Usage**: < 50MB for 100 cached emoji images
- **Document Generation**: < 15% overhead vs text-only emoji
- **File Size Impact**: Estimate 2-5KB per unique emoji in document

## Testing Plan

### Unit Tests

1. **Unicode Processing**
   - Surrogate pair extraction
   - Filename generation
   - Composite emoji handling

2. **Image Management**
   - PNG file loading
   - Cache functionality
   - Error handling

3. **PDF Generation**
   - XObject creation
   - Resource dictionary updates
   - Operator generation

### Integration Tests

1. **Mixed Content Documents**
   - Text with multiple emoji
   - Different font sizes
   - Various emoji types

2. **Error Scenarios**
   - Missing image files
   - Corrupted PNG data
   - Invalid Unicode sequences

3. **Performance Tests**
   - Large documents with many emoji
   - Memory usage validation
   - Cache effectiveness

### Test Data

```clojure
;; Test emoji set
(def test-emoji
  ["💡"    ; Lightbulb (basic emoji)
   "🎯"    ; Target (game emoji) 
   "👨‍💻"   ; Man technologist (composite)
   "👋🏽"   ; Waving hand with skin tone
   "🏴‍☠️"   ; Pirate flag (multiple ZWJ)])
```

### Validation Criteria

- All test emoji render correctly in generated PDFs
- PDF files open successfully in major viewers (Adobe, Preview, Firefox)
- Performance meets specified targets
- Memory usage remains within limits
- Fallback strategies work correctly

## File Structure

```
src/hiccup_pdf/
├── emoji.cljs              # Unicode processing
├── images.cljs             # Image loading and caching
├── text_processing.cljs    # Mixed content handling
└── core.cljs              # Enhanced main functions

test/hiccup_pdf/
├── emoji_test.cljs         # Unicode and filename tests
├── images_test.cljs        # Image loading tests
├── integration_test.cljs   # End-to-end tests
└── performance_test.cljs   # Performance validation

emojis/
└── noto-72/               # Noto emoji PNG files
    ├── emoji_u1f4a1.png   # 💡 lightbulb
    ├── emoji_u1f3af.png   # 🎯 target
    └── ...                # Additional emoji files
```

## Migration Strategy

### Phase 1: Core Implementation
1. Implement Unicode processing functions
2. Add image loading and caching
3. Create basic PDF embedding

### Phase 2: Integration
1. Enhance text processing pipeline
2. Update document generation
3. Add configuration options

### Phase 3: Optimization
1. Implement performance optimizations
2. Add comprehensive error handling
3. Complete testing suite

### Backwards Compatibility

- Existing hex string encoding remains default
- New emoji images feature opt-in via configuration
- All current functionality preserved
- Gradual migration path for users

## Dependencies

```clojure
;; Additional dependencies needed
{"node:fs" "Built-in Node.js file system module"
 "node:path" "Built-in Node.js path utilities"}
```

## Success Metrics

- **Functionality**: All emoji in Noto library supported
- **Quality**: Visually indistinguishable from native emoji
- **Performance**: < 15% document generation overhead
- **Compatibility**: Works across major PDF viewers
- **Reliability**: < 1% failure rate for emoji rendering

## Future Enhancements

1. **Additional Emoji Sets**: Support for Apple, Twitter emoji styles
2. **Dynamic Loading**: Download emoji from CDN when local files missing
3. **SVG Support**: Use vector emoji for better scalability
4. **Color Profiles**: Support for different color spaces
5. **Compression**: Optimize PNG files for smaller PDF size

---

This specification provides a complete blueprint for implementing emoji image embedding in the hiccup-pdf library, maintaining high quality standards while ensuring backwards compatibility and optimal performance.